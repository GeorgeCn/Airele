<html>
<head>
	<meta charset="utf-8">
	<title>审核房间</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"><!-- 最新版本渲染 -->
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/css/audit_rent_orders.css">
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/css/basic.css">
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/css/common.css">
</head>
<body>
<include file="Public/head_city" />
    <div class="title cf">
    	<div class="logo fl cf">
			<img src="__PUBLIC__/images/logo.png">
		</div>
		<ul class="cf fl">
		<li><a href="{:U('Welcome/welcome')}">首页</a></li>
			{$menutophtml}
		</ul>
		<div class="cf fr title_right">
			<a class="blue" href="javascript:">欢迎您 <?php echo cookie("admin_user_name");?></a>
			<span>|</span>
			<a href="{:U('/Index/outlogin')}">退出</a>
		</div>
    </div>
	<div class="main">
		<div class="main_left subNavBox">
		<include file="Public/left_menu" />
			{$menulefthtml}
		</div>
		<div class="main_right">
			<div class="common_head">
				<h2>审核房间</h2>
			</div>

			<div class="common_main">
				<!-- 表单 -->
				<form id="submitForm" action="__URL__/submitRoomModify" method="post" enctype='multipart/form-data'>
					<input type="hidden" name="handle" value="<?php echo isset($_GET['handle'])?$_GET['handle']:'' ?>">
				<table class="table_one table_two">
					<tr>
						<td colspan="2">房间信息</td>
					</tr>
					<tr>
						<td class="td_title"><span>*</span>房间名称：</td>
						<td class="td_main">
							<select id="room_name" name="room_name">
								<option value="">请选择</option>
								{$roomNames}
							</select>
						</td>
					</tr>
					<tr>
						<td class="td_title"><span>*</span>房间面积：</td>
						<td><input type="text" id="room_area" name="room_area" value="{$roomModel['room_area']}" maxlength="3" class="smallwidth">平方米</td>
					</tr>
					<tr>
						<td class="td_title"><span>*</span>租金：</td>
						<td class="td_main"><input type="text" id="room_money" name="room_money" maxlength="5" value="{$roomModel['room_money']}" class="smallwidth">元/月</td>
					</tr>
					<tr>
						<td class="td_title"><span>*</span>总数量：</td>
						<td><input type="text" id="total_count" name="total_count" value="{$roomModel['total_count']}" maxlength="3" class="smallwidth"></td>
					</tr>
					<tr>
						<td class="td_title"><span>*</span>可租数量：</td>
						<td><input type="text" id="up_count" name="up_count" value="{$roomModel['up_count']}" maxlength="3" class="smallwidth"></td>
					</tr>
					<tr>
						<td class="td_title"><span>*</span>房间朝向：</td>
						<td class="td_main">
							<select id="room_direction" name="room_direction">
								<option value="">请选择</option>
								{$roomDirectionList}
							</select>
						</td>
					</tr>
					<tr>
						<td class="td_title"><span>*</span>房间设施：</td>
						<td class="td_main">
							{$room_equipment}
						</td>
					</tr>
					<tr>
						<td class="td_title">特色标签：</td>
						<td class="td_main">
							<label><input type="checkbox" id="feature_tag" name="feature_tag[]">随意退（3天内退押金与剩余租金，提前30天退押金）</label>
						</td>
					</tr>
					<tr>
						<td class="td_title">特色标签：</td>
						<td class="td_main">
							<label><input type="radio" name="girl_tag" value="0">无</label>&nbsp;
							<label><input type="radio" name="girl_tag" value="1">限女生</label>&nbsp;
							<label><input type="radio" name="girl_tag" value="2">限男生</label>
						</td>
					</tr>
					<tr>
						<td class="td_title">房间介绍：</td>
						<td class="td_main"><textarea id="room_description" name="room_description">{$roomModel['room_description']}</textarea></td>
					</tr>
					<tr>
						<td colspan="2">房间照（<span>必须上传真实照片</span>）&nbsp;&nbsp;<a href="javascript:" onclick="deleteImgs()">删除所有图片</a>&nbsp;&nbsp;
						<!-- <a href="__URL__/downloadImgs?room_id={$roomModel['id']}">下载所有图片</a> --></td>
					</tr>
				</table>
				<div class="roompic">
					<div class="cf photos">
						<p class="fl">房间照（<span id="imgcount">0</span>/9）&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>至少上传1张，建议上传16：9的横向照片(最大<span style="color:red;">5M</span>)</span></p>

						<div class="uploadPhotos fl">
							<span>上传照片</span>
							<!-- <form id='myupload' action='__URL__/uploadImage' method='post' enctype='multipart/form-data'> -->
								<input id="fileupload" type="file" name="mypic[]" multiple />
								<input type="hidden" id="room_id" name="room_id" value="{$roomModel['id']}" />
							<!-- </form> -->
							<input type="hidden" id="uploadcount" name="uploadcount" />
						</div>
						
						<p id="upload_warn" style="margin-left:35px;line-heigth:50px;color:red;display:none;">上传中...</p>
					</div>
					<ul class="cf" id="imglist">{$imgString}</ul>
				</div>
				<table class="table_one table_two">
					<tr>
						<td colspan="2">房间状态</td>
					</tr>
					<tr>
						<td class="td_title"><span></span>房间状态：</td>
						<td class="td_main">
							<label><input type="radio" name="status" value="0" checked="checked" />待审核</label>&nbsp;
							<label><input type="radio" name="status" value="2" />审核通过(未入住状态)</label>&nbsp;
							<label><input type="radio" name="status" value="1" />审核不通过</label>&nbsp;
						</td>
					</tr>
					<tr>
						<td class="td_title"><span></span>审核不通过原因：</td>
						<td class="td_main"><input type="text" name="ext_examineinfo" value="{$roomModel['ext_examineinfo']}" style="width:80%"></td>
					</tr>
					<tr>
						<td class="td_title"><span></span>房间备注：</td>
						<td class="td_main"><input type="text" name="room_bak" value="{$roomModel['room_bak']}" style="width:80%"></td>
					</tr>
				</table>
				</form>
				<div class="addhouse_last addhouse_last_room"><a href="javascript:window.history.back();" class="btn_b">返回</a><a href="javascript:;" id="submit_a" class="btn_a">提交</a></div>
			</div>
		</div>
</body>
<script src="__PUBLIC__/js/jquery.js"></script>
<script src="__PUBLIC__/js/common.js"></script>
<script src="__PUBLIC__/js/jquery.form.js"></script>
<script type="text/javascript">
	/*绑定数据 */
	var room_name='{$roomModel["room_name"]}';
	$("#room_name").val(room_name);
	var room_direction='{$roomModel["room_direction"]}';
	var room_equipment='{$roomModel["room_equipment"]}';
	if("1"=='{$roomModel["feature_tag"]}'){
		$("#feature_tag").attr("checked","checked");
	}
	var girl_tag='{$roomModel["girl_tag"]}';
	$("input[name=girl_tag][value="+girl_tag+"]").attr("checked","checked");
	$("#room_direction").val(room_direction);
	if(room_equipment !=''){
		var equipment_array=room_equipment.split(",");
		for (var i = equipment_array.length - 1; i >= 0; i--) {
			$("input[name^=room_equipment][value="+equipment_array[i]+"]").attr("checked","checked");
		};
	}
	var imgcount=$("#imglist li").length;
	$("#imgcount").text(imgcount);
	//主图片绑定
	var main_imgid='{$roomModel["main_img_id"]}';
	$("input[name=main_img][value^="+main_imgid+"]").attr("checked","checked");
	//房间状态
	var room_status='{$roomModel["status"]}';
	$("input[name=status][value="+room_status+"]").attr("checked","checked");
	$("input[name=status]").change(function(){
		if($(this).val()=="2"){
			$("#up_count").val(1);
		}else{
			$("#up_count").val(0);
		}
	});
	/*删除图片*/
	function removePic(img_id,obj){
		var imgsObj=$("#imglist li:visible");
		if(imgsObj.length==1){
			alert('至少保留1张图片');
			return;
		}
		if(confirm("确定要删除吗？")){
			$.get('__URL__/deleteImage',{img_id:img_id},function(data){
				if(data.status=="200"){
					$(obj).parent().hide();
					var img_count=parseInt($("#imgcount").text());
					$("#imgcount").text(img_count-1);
					$("#uploadcount").val(imgcount-1);
				}else{
					alert(data.msg);
				}
			},'json');
		}
	}
	function downloadImgs(){
		if(confirm("确定要下载所有图片到本地吗？")){
			$("#upload_warn").html("下载中...").show();
			$.get('__URL__/downloadImgs',{room_id:$("#room_id").val()},function(data){
				$("#upload_warn").hide();
				if(data.status=="200"){
					alert("下载成功");
				}else{
					alert(data.msg);
				}
			},'json');
		}
	}
	function deleteImgs(){
		if(confirm("确定要删除房间下所有图片吗？")){
			$("#upload_warn").html("删除中...").show();
			$.get('__URL__/deleteImgs',{room_id:$("#room_id").val()},function(data){
				$("#upload_warn").hide();
				if(data.status=="200"){
					window.location.reload();
				}else{
					alert(data.msg);
				}
			},'json');
		}
	}

$(function () {
	/*上传图片*/
    $("#fileupload").change(function(){
    	var imgcount=parseInt($("#imgcount").text());
    	if(imgcount>=9){
    		alert("最多上传9张图片");
    		return;
    	}
		$("#submitForm").ajaxSubmit({
			dataType:  'json',
			data:{submitType:'upload'},
			beforeSend: function() {
				$("#upload_warn").html("上传中...").show();
    		},
    		uploadProgress: function(event, position, total, percentComplete) {
    		},
			success: function(result) {
				var img_data=result.data;
				for (var i = img_data.length - 1; i >= 0; i--) {
					var img_url=img_data[i].imgUrl;
					var point_index=img_url.lastIndexOf(".");
					var corp_img_url=img_url.substring(0,point_index)+"_200_130"+img_url.substring(point_index);
					$("#imglist").append('<li><img src="'+corp_img_url+'" alt=""><br/><a href="javascript:;" onclick="removePic(\''+img_data[i].imgId+'\',this)">删除</a><br/><label><input type="radio" value="'+img_data[i].imgId+','+img_url+'" name="main_img">封面</label></li>');
				};
				$("#imgcount").text(imgcount+img_data.length);
				$("#uploadcount").val(imgcount+img_data.length);
				$("#fileupload").val('');
				$("#upload_warn").hide();
			},
			error:function(xhr){
				$("#upload_warn").hide();
				alert(xhr.responseText);
			}
		});
	});
});
</script>
<script type="text/javascript">
	/*提交表单*/
	$("#submit_a").bind("click",function(){
		btnSubmit();
	});
	function btnSubmit(){
		var status=$('input:radio[name="status"]:checked').val();
		if(status=='0'){
			alert('请先选择审核状态');return;
		}else if(status=='1'){
			if($("input[name=ext_examineinfo]").val().replace(/\s+/g,'')==''){
				alert('请填写审核不通过原因');return;
			}else{
				/*提交不通过 */
				$("#submit_a").unbind("click");
				$("#submit_a").text("提交中...");
				$("#submitForm").submit();
			}
		}else{
			if($("#room_name").val()==""){
				alert('请选择房间名称');return;
			}
			var numExp=/^\d{1,5}$/;
			var floatExp=/^([1-9]\d*\.\d*|0\.\d+|[1-9]\d*|0)$/;
			if(!floatExp.test($("#room_area").val())){
				alert('房间面积必填，且为有效值');
				$("#room_area").focus();return;
			}
			if(!numExp.test($("#room_money").val())){
				alert('租金必填，且为整数');
				$("#room_money").focus();return;
			}
			if(parseFloat($("#room_area").val())<4){
				alert('房间面积不能小于4㎡');
				$("#room_area").focus();return;
			}
			if(parseInt($("#room_money").val())<100){
				alert('租金不能小于100元');
				$("#room_money").focus();return;
			}
			if($("#room_direction").val()==""){
				alert('请选择房间朝向');return;
			}
			var equipment_count=$("input[name^=room_equipment]:checked").length;
			if(equipment_count==0){
				alert('请勾选房间设施');return;
			}
			var imgsObj=$("#imglist li:visible");
			var imgcount=imgsObj.length;
			if(imgcount==0){
				alert('至少上传1张图片');return;
			}
			var mainimg_count=imgsObj.find("input[name=main_img]:checked").length;
			if(mainimg_count==0){
				alert('请设置房间照封面');return;
			}
			$("#submit_a").unbind("click").text("提交中...");
			$("#submitForm").submit();
		}
		
	}
</script>
</html>

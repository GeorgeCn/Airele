<html>
<head>
	<meta charset="utf-8">
	<title>抓取上房</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"><!-- 最新版本渲染 -->
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/css/audit_rent_orders.css">
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/css/basic.css">
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/css/common.css">
</head>
<body>
<include file="Public/head_city" />
    <div class="title cf">
    	<div class="logo fl cf">
			<img src="__PUBLIC__/images/logo.png">
		</div>
		<ul class="cf fl">
		<li><a href="{:U('Welcome/welcome')}">首页</a></li>
			{$menutophtml}
		</ul>
		<div class="cf fr title_right">
			<a class="blue" href="javascript:">欢迎您 <?php echo cookie("admin_user_name");?></a>
			<span>|</span>
			<a href="{:U('/Index/outlogin')}">退出</a>
		</div>
    </div>
	<div class="main">
		<div class="main_left subNavBox">
		<include file="Public/left_menu" />
			{$menulefthtml}
		</div>
		<div class="main_right">
			<div class="common_main">
				<form id="submitForm" action="__URL__/submitUprobhouse" method="post" enctype="multipart/form-data">
					<div class="roompic">
						<div class="cf photos">
							<p class="fl">房间照（<span id="imgcount">0</span>/9）&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>至少上传1张，建议上传16：9的横向照片(最大<span style="color:red;">5M</span>)</span></p>

							<div class="uploadPhotos fl">
								<span>上传照片</span>
								
								<input id="fileupload" type="file" name="mypic[]" multiple="multiple">
								<input type="hidden" id="room_id" name="room_id" value="{$roomModel['id']}">
								
								<input type="hidden" id="uploadcount" name="uploadcount">
							</div>
							
							<p id="upload_warn" style="margin-left:35px;line-heigth:50px;color:red;display:none;">上传中...</p>
						</div>
						<ul class="cf" id="imglist">{$imgString}</ul>
					</div>
				<table class="table_one table_two">
					<tr>
						<td class="td_title">房间介绍</td>
						<td class="td_main"><textarea id="room_description" name="room_description">{$roomModel['room_description']}</textarea></td>
					</tr>
					<tr>
						<td class="td_title">房东姓名</td>
						<td class="td_main"><input type="text" data-name="房东姓名" id="client_name" name="client_name" value="{$resourceModel['client_name']}" maxlength="5"></td>
					</tr>
					<tr>
						<td class="td_title">房东电话</td>
						<td class="td_main"><input type="text" data-name="房东电话" id="client_phone" name="client_phone" value="{$resourceModel['client_phone']}" maxlength="24">&nbsp;<span style="color:red;" id="warnBlackUser"></span></td>
					</tr>
					
					
					<!-- 出租类型 -->
					<tr>
						<td class="td_title">房东类型</td>
						<td class="td_main">
							<label><input type="radio" name="rental_type" value="1">个人转租</label>&nbsp;&nbsp;
							<label><input type="radio" name="rental_type" value="3">职业二房东</label>&nbsp;&nbsp;
							<label><input type="radio" name="rental_type" value="4">房东直租</label>&nbsp;&nbsp;
						</td>
					</tr>
					<!--Start 房屋信息 -->

					<tr>
						<td colspan="2"><span>整套信息</span></td>
					</tr>
					
					<tr><td class="td_title">原网站地址</td>
						<td class="td_main">
							{$resourceModel['region_name']}<neq name="resourceModel.estate_address" value="">&nbsp;&nbsp;{$resourceModel['estate_address']}</neq>
						</td></tr>
					<tr>
						<td class="td_title">小区名称</td>
						<td class="td_main">
							<input type="hidden" name="business_type" value="{$resourceModel['business_type']}">
							<input type="hidden" id="resource_id" name="resource_id" value="{$resourceModel['id']}" />
							<input type="text" data-name="小区名称" id="estate_name" name="estate_name" value="{$resourceModel['estate_name']}" class="plotIpt" style="width:90%;">
							<input type="hidden" id="estate_id" name="estate_id" value="{$resourceModel['estate_id']}" />
							<input type="hidden" id="region" name="region" value="{$resourceModel['region_id']}" />
							<input type="hidden" id="scope" name="scope" value="{$resourceModel['scope_id']}" />
							<div id="estate_div" class="plotbox" style="width:90%;">
								<ul>
								</ul>
							</div>
						</td>
					</tr>
					<tr>
						<td class="td_title">户型</td>
						<td class="td_main"><input type="tel" id="room_num" value="{$resourceModel['room_num']}" name="room_num" maxlength="2" class="smallwidth">室&nbsp;&nbsp;<input type="tel" id="hall_num" name="hall_num" value="{$resourceModel['hall_num']}" maxlength="1" class="smallwidth">厅&nbsp;&nbsp;<input type="tel" id="wei_num" name="wei_num" value="{$resourceModel['wei_num']}" maxlength="1" class="smallwidth">卫</td>
					</tr>
					<!-- <tr>
						<td class="td_title">楼栋室号：</td>
						<td><input type="tel" id="unit_no" name="unit_no" value="{$resourceModel['unit_no']}" maxlength="5" class="smallwidth">楼栋/单元号&nbsp;&nbsp;<input type="tel" id="room_no" name="room_no" value="{$resourceModel['room_no']}" maxlength="5" class="smallwidth">室号</td>
					</tr> -->
					<tr>
						<td class="td_title">整套面积</td>
						<td class="td_main"><input type="text" data-name="整套面积" id="area" name="area" value="{$resourceModel['area']}" maxlength="4" class="smallwidth">平方米</td>
					</tr>
					<tr>
						<td class="td_title">房间类型</td>
						<td class="td_main">
							<select id="rent_type" name="rent_type" data-name="房间类型">
								<option value="">请选择</option>
								<option value="1">合租</option>
								<option value="2">整租</option>
							</select>&nbsp;&nbsp;
							<label id="lbl_iscut">是否隔断&nbsp;<select name="is_cut">
								<option value="0">请选择</option>
								<option value="1">是</option>
							</select></label>
						</td>
					</tr>
					<tr>
						<td class="td_title">共用设施</td>
						<td class="td_main">
							{$publicEquipmentList}
						</td>
					</tr>
					
					<tr>
						<td colspan="2"><span>房间信息</span></td>
					</tr>
					<tr>
						<td class="td_title">房间名称</td>
						<td class="td_main">
							<select id="room_name" name="room_name" data-name="房间名称">
								<option value="">请选择</option>
								{$roomNames}
							</select>
						</td>
					</tr>
					<tr>
						<td class="td_title">房间面积</td>
						<td><input type="text" data-name="房间面积" id="room_area" name="room_area" value="{$roomModel['room_area']}" maxlength="3" class="smallwidth">平方米</td>
					</tr>
					<tr>
						<td class="td_title">租金</td>
						<td class="td_main"><input type="text" data-name="租金" id="room_money" name="room_money" maxlength="5" value="{$roomModel['room_money']}" class="smallwidth">元/月</td>
					</tr>
				
					<tr>
						<td class="td_title">房间设施</td>
						<td class="td_main">
							{$room_equipment}
						</td>
					</tr>
					<tr>
						<td class="td_title">特色标签</td>
						<td class="td_main">
							<label><input type="radio" name="girl_tag" value="0" checked="checked">无</label>&nbsp;
							<label><input type="radio" name="girl_tag" value="1">限女生</label>&nbsp;
							<label><input type="radio" name="girl_tag" value="2">限男生</label>
						</td>
					</tr>

					<tr>
						<td class="td_title">房间朝向</td>
						<td class="td_main">
							<select id="room_direction" name="room_direction" data-name="房间朝向">
								<option value="">请选择</option>
								{$houseDirectionList}
							</select>
						</td>
					</tr>
					<tr>
						<td colspan="2"><span>其他信息</span></td>
					</tr>
					<tr>
						<td class="td_title">楼层</td>
						<td class="td_main"><input type="tel" id="floor" name="floor" value="{$resourceModel['floor']}" maxlength="3" class="smallwidth">层&nbsp;&nbsp;&nbsp;&nbsp;共&nbsp;<input type="tel" id="floor_total" name="floor_total" value="{$resourceModel['floor_total']}" maxlength="3" class="smallwidth">层</td>
					</tr>
					
					<tr>
						<td class="td_title">装修情况</td>
						<td class="td_main">
							<select id="decoration" name="decoration" data-name="装修情况">
								<option value="">请选择</option>
								{$decorationList}
							</select>
						</td>
					</tr>
					<tr>
						<td class="td_title">付款方式</td>
						<td class="td_main">
							<select id="pay_method" name="pay_method" data-name="付款方式">
								<option value="">请选择</option>
								{$payMethodList}
							</select>
						</td>
					</tr>
				
				</table>
				<!--End 房间信息 -->
			
				</form>
				<div class="addhouse_next"><a href="javascript:;" id="submit_a" class="btn_a">提交</a></div>
			</div>
		</div>
</body>
<script src="__PUBLIC__/js/jquery.js"></script>
<script src="__PUBLIC__/js/common.js"></script>
<script src="__PUBLIC__/js/jquery.form.js"></script>

<script type="text/javascript">
	/*绑定数据 */

	$("#decoration").val('{$resourceModel["decoration"]}');
	$("#pay_method").val('{$resourceModel["pay_method"]}');

	var public_equipment='{$resourceModel["public_equipment"]}';
	if(public_equipment !=''){
		var equipment_array=public_equipment.split(",");
		for (var i = equipment_array.length - 1; i >= 0; i--) {
			$("input[name^=public_equipment][value="+equipment_array[i]+"]").attr("checked","checked");
		};
	}
	//暂无设施，点击事件
	$("input[name^=public_equipment][value='0312']").click(function(){
		if($(this).attr('checked')=='checked'){
			$("input[name^=public_equipment][value!='0312']").removeAttr("checked");
		}
	});
	$("input[name^=room_equipment][value='1114']").click(function(){
		if($(this).attr('checked')=='checked'){
			$("input[name^=room_equipment][value!='1114']").removeAttr("checked");
		}
	});
	
	/*选择小区*/
	function selectEstate(estate_id,estate_name,region,scope,business_type){
		$("#estate_id").val(estate_id);
		$("#estate_name").val(estate_name);
		$("#region").val(region);
		$("#scope").val(scope);
		$("input[name='business_type']").val(business_type);
		$("#estate_div").hide();
	}
	/*黑名单*/
	$("#client_phone").blur(function(){
		$.get("__URL__/checkBlackUser",{mobile:$(this).val()},function(data){
			if(data.status!="200"){
				$("#warnBlackUser").text(data.msg);
			}else{
				$("#warnBlackUser").text("");
			}
		},"json");
	});
$(document).ready(function(){
	var last;
	$("#estate_name").keyup(function(event){
		//利用event的timeStamp来标记时间，这样每次的keyup事件都会修改last的值，注意last必需为全局变量
		last = event.timeStamp;
		setTimeout(function(){    
			//如果时间差为0（也就是你停止输入0.5s之内都没有其它的keyup事件发生）则做你想要做的事
			if(last-event.timeStamp==0){
				var key_word=$("#estate_name").val();
				if(key_word.length<1){
					return;
				}
				/*检索小区*/
	           //var typeValue=$('input:radio[name="business_type"]:checked').val();
	           $.get("__ROOT__/HouseResource/searchestate",{keyword:key_word,type:''},function(result){
	           	console.log(key_word);
	           	if(result.status=="200"){
	           		var attr=result.data;
	           		var len=attr.length;
	           		var obj=$("#estate_div ul");
	           		obj.html("");
	           		for (var i = len-1; i >= 0; i--) {
	           			obj.append("<li onclick=\"selectEstate('"+attr[i].id+"','"+attr[i].estate_name+"','"+attr[i].region+"','"+attr[i].scope+"','"+attr[i].business_type+"')\" >"+attr[i].estate_name+"--"+attr[i].estate_address+"--"+attr[i].business_typename+"--"+attr[i].region_name+"-"+attr[i].scope_name+"</li>");
	           		};
	           		if(len>0){
	           			$("#estate_div").show();
	           		}else{
	           			$("#estate_div").hide();
	           		}
	           	}
	           },"json");          
	        }
		},500);
	});
});

	/*提交表单*/
	$("#submit_a").bind("click",function(){
		btnSubmit();
	});
	function btnSubmit(){
		/*信息校验 */
		var inputAll=true;var warnText="";
		$("#submitForm input[type='text']").each(function(){
			if($(this).val()==''){
				inputAll=false;	warnText=$(this).attr("data-name");
				return;
			}
		});
		if(inputAll){
			$("#submitForm select").each(function(){
				if($(this).val()==''){
					if($(this).attr("name")!="is_cut"){
						//$(this).attr("id")!="brand_type" &&
						inputAll=false;	warnText=$(this).attr("data-name");
						return;
					}
				}
			});
		}
		if(!inputAll){
			alert(warnText+" 不能为空");return;
		}
		var numExp=/^\d{1,5}$/;
		var floatExp=/^([1-9]\d*\.\d*|0\.\d+|[1-9]\d*|0)$/;
		var area=parseFloat($("#area").val());
		var room_area=parseFloat($("#room_area").val());
		
		/*房源信息校验 */
		if(area<5 || isNaN(area)){
			alert('整套面积不能<5㎡');return;
		}
		if(parseInt($("#floor").val())>parseInt($("#floor_total").val())){
			alert('所在楼层不能超过总楼层');return;
		}
		if($("input[name^=public_equipment]:checked").length==0){
			alert('须勾选共用设施');return;
		}
		var rentalType=$('input:radio[name="rental_type"]:checked').val();
		if(rentalType==undefined){
			alert("请选择 房东类型");return;
		}
        var isTel=/^(\d+\,{0,1}\d*){11,24}$/;
        if(!isTel.test($("#client_phone").val())){
        	alert('房东电话必须填写正确');return;
        }
        /*房间信息校验 */
        if($("#room_name").val()==""){
			alert('请选择房间名称');return;
		}
		var roomMoney=parseInt($("#room_money").val());
		if(roomMoney<100 || isNaN(roomMoney)){
			alert('租金不能<100元');return;
		}
		if(room_area<5 || isNaN(room_area)){
			alert('房间面积不能<5㎡');return;
		}
		if($("#room_direction").val()==""){
			alert('请选择房间朝向');
			return;
		}
		if($("input[name^=room_equipment]:checked").length==0){
			alert('请勾选房间设施');
			return;
		}
		var imgsObj=$("#imglist li:visible");
		if(imgsObj.length==0){
			alert('请上传图片');
			return;
		}
		console.log(imgsObj.find("input[name='main_img']:checked").length);
		console.log(imgsObj.find("input[name='main_imgnew']:checked").length);
		if(imgsObj.find("input[name='main_img']:checked").length==0 && imgsObj.find("input[name='main_imgnew']:checked").length==0){
			alert('请设置房间照封面');
			return;
		}
		/*新增提醒 */
		if($("select[name='rent_type']").val()=='1'){
			if(room_area>=area){
				alert('合租的房间面积不能大于或等于整套面积');return;
			}
			if(room_area>=40){
				if(!confirm('本单间的面积已经≥40㎡，是否确认提交？')){return;}
			}
		}else{
			if(room_area!=area){
				alert('整租的房间面积必须等于整套面积');return;
			}
			var roomNum=parseInt($("input[name='room_num']").val());
			if(roomNum==1 && area>=100){
				if(!confirm('本整租1室的面积已经≥100㎡，是否确认提交？')){return;}
			}else if(roomNum==2 && area>=150){
				if(!confirm('本整租2室的面积已经≥150㎡，是否确认提交？')){return;}
			}else if(roomNum>=3 && area>=250){
				if(!confirm('本整租的面积已经≥250㎡，是否确认提交？')){return;}
			}
		}
		var cityId=$(".citySelect select").val();
		var areaMoney=parseInt(roomMoney/room_area);
		if(cityId==1 || cityId==2) {
			if(areaMoney<=25 || areaMoney>=300){
				if(!confirm('北京/上海的正常房租在[￥25/㎡，￥300/㎡]之间，本房间的租金异常，是否确认提交？')){return;}
			}
		}else if(cityId==3 || cityId==4){
			if(areaMoney<=15 || areaMoney>=200){
				if(!confirm('南京/杭州的正常房租在[￥15/㎡，￥200/㎡]之间，本房间的租金异常，是否确认提交？')){return;}
			}
		}
		sureSubmit();
	}
	function sureSubmit(){
		/*检查*/
		$("#submit_a").unbind("click").text("提交中..");
		//var typeValue=$('input:radio[name="business_type"]:checked').val();
		$.get("__URL__/checkAddResourceInfo",{estate_id:$("#estate_id").val(),estate_name:$("#estate_name").val(),type:'',client_phone:$("#client_phone").val()},function(result){
			if(result.status=="200"){
				if($("#estate_id").val()==""){
					var jsonObj=result.data[0];
					$("#estate_id").val(jsonObj.id);
					$("#estate_name").val(jsonObj.estate_name);
					$("#region").val(jsonObj.region);
					$("#scope").val(jsonObj.scope);
					$("input[name='business_type']").val(jsonObj.business_type);
				}
				if(result.msg=="success"){
					$("#submitForm").submit();/*提交*/
				}else{
					if(confirm('房东电话下已有房源，是否确定提交？')){
						$("#submitForm").submit();/*提交*/
					}else{
						$("#submit_a").bind("click",function(){
							btnSubmit();
						});
						$("#submit_a").text("提交");
					}
				}
			}else{
				alert(result.msg);
				$("#submit_a").bind("click",function(){
					btnSubmit();
				});
				$("#submit_a").text("提交");
			}
		},"json");
	}
</script>
<!-- 房间信息 -->
<script type="text/javascript">
	/*绑定数据 */
	$("#room_name").val('{$roomModel["room_name"]}');
	var room_names='<option value="">请选择</option><option value="主卧">主卧</option><option value="次卧A">次卧A</option><option value="次卧B">次卧B</option><option value="次卧C">次卧C</option><option value="次卧D">次卧D</option><option value="次卧E">次卧E</option><option value="次卧F">次卧F</option><option value="次卧G">次卧G</option><option value="次卧H">次卧H</option><option value="次卧I">次卧I</option><option value="客厅">客厅</option><option value="床位">床位</option>';
	if($("#room_name").val()==''){
		$("#room_name").html(room_names);
	}
	$("#rent_type").change(function(){
		if($(this).val()=='2'){
			$("#room_name").html('<option value="整套">整套</option>');
			$("#lbl_iscut").hide();$("select[name='is_cut']").val('0');
		}else{
			var businessType=$("input[name='business_type']").val();
			if(businessType=='1502' || businessType=='1503'){
				$("#room_name").html('<option value="">请选择</option><option value="主卧">主卧</option><option value="次卧">次卧</option><option value="床位">床位</option>');
			}else{
				$("#room_name").html(room_names);
			}
			$("#lbl_iscut").show();
		}
	});
	$("#room_direction").val('{$roomModel["room_direction"]}');

	var girl_tag='{$roomModel["girl_tag"]}';
	$("input[name=girl_tag][value="+girl_tag+"]").attr("checked","checked");
	var room_equipment='{$roomModel["room_equipment"]}';
	if(room_equipment !=''){
		var equipment_array=room_equipment.split(",");
		for (var i = equipment_array.length - 1; i >= 0; i--) {
			$("input[name^=room_equipment][value="+equipment_array[i]+"]").attr("checked","checked");
		};
	}
	$("#imgcount").text($("#imglist li").length);
	//主图片绑定
	var main_imgid='{$roomModel["main_img_id"]}';
	$("input[name=main_img][value^="+main_imgid+"]").attr("checked","checked");
	//房间状态
	/*var room_status='{$roomModel["status"]}';
	$("input[name=status][value="+room_status+"]").attr("checked","checked");*/
	/*删除图片*/
	function removePic(img_id,obj){
		var imgsObj=$("#imglist li:visible");
		if(imgsObj.length==1){
			alert('至少保留1张图片');
			return;
		}
		if(confirm("确定要删除吗？")){
			$.get('__ROOT__/HouseRoomrob/deleteImage',{img_id:img_id},function(data){
				if(data.status=="200"){
					$(obj).parent().hide();
					var img_count=parseInt($("#imgcount").text());
					$("#imgcount").text(img_count-1);
					$("#uploadcount").val(imgcount-1);
				}else{
					alert(data.msg);
				}
			},'json');
		}
	}
	function deleteImgs(){
		if(confirm("确定要删除房间下所有图片吗？")){
			$("#upload_warn").html("删除中...").show();
			$.get('__ROOT__/HouseRoomrob/deleteImgs',{room_id:$("#room_id").val()},function(data){
				$("#upload_warn").hide();
				if(data.status=="200"){
					window.location.reload();
				}else{
					alert(data.msg);
				}
			},'json');
		}
	}

$(function () {
	/*上传图片*/
    $("#fileupload").change(function(){
    	var imgcount=parseInt($("#imgcount").text());
    	if(imgcount>=9){
    		alert("最多上传9张图片");
    		return;
    	}
		$("#submitForm").ajaxSubmit({
			dataType:  'json',
			data:{submitType:'upload'},
			beforeSend: function() {
				$("#upload_warn").html("上传中...").show();
    		},
    		uploadProgress: function(event, position, total, percentComplete) {
    		},
			success: function(result) {
				var img_data=result.data;
				for (var i = img_data.length - 1; i >= 0; i--) {
					var img_url=img_data[i].imgUrl;
					var point_index=img_url.lastIndexOf(".");
					var corp_img_url=img_url.substring(0,point_index)+"_200_130"+img_url.substring(point_index);
					$("#imglist").append('<li><img src="'+corp_img_url+'" alt=""><br><label><input type="radio" value="'+img_data[i].imgId+','+img_url+'" name="main_imgnew">封面</label></li>');
				};
				$("#imgcount").text(imgcount+img_data.length);
				$("#uploadcount").val(imgcount+img_data.length);
				$("#fileupload").val('');
				$("#upload_warn").hide();
			
				$("input[name='main_img']").each(function(){
					$(this).attr("checked",false);
				}).hide();
				
			},
			error:function(xhr){
				$("#upload_warn").hide();
				if(xhr.responseText!=""){
					alert(xhr.responseText);
				}
				
			}
		});
	});
});
</script>
</html>

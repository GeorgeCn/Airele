<?php
namespace Home\Controller;
use Think\Controller;
/*测试，批量处理 */
class TestController extends Controller {

	#批量拉黑
	public function pull_black(){
		header("content-type:text/html;charset=utf-8");
		if(I('get.handle')=='pull'){
			$customerDal=new \Home\Model\customer();
			$list=$customerDal->getListByWhere(" `mobile` in ('13764010598', '18049716063', '15159995855', '2162169266', '15216614486', '15317759760', '18242361133', '18519697898', '18621775212', '18760599992', '13564282588', '15021622529', '18221019376', '13816034188', '18362579895', '13482300919', '13636541959', '13681914176', '15000818897', '18017897075', '13321961386', '13341665760', '13621995874', '13816337204', '13818721128', '15901699294', '17191591267', '18201708215', '18321006070', '18702182729', '18055372000', '13184234473', '15000245119', '13166352563', '18217261506', '17602194390', '13127876779', '13185209159', '13623631765', '13338677773', '13564367807', '13701848363', '15900610557', '17701602011', '17740827341', '18017205585', '13386060270', '13816363125', '15000189252', '15921053602', '18321220048', '18516738060', '18621638705', '18721317006', '13681960504', '13701999206', '18001898997', '18221868135', '18049985071', '18321837165', '13052050670', '13058748017', '13162007372', '15121081087', '15121107017', '18616537919', '15221266267', '18555386997', '13564170933', '13816567820', '18217338470', '13023221970', '13391086430', '13564195326', '13671554646', '13761683196', '15317988935', '15800406053', '15949113112', '17316325180', '18020630236', '18221532031', '18752022622', '15921833571', '13585906340', '15026761306', '18221818586', '18221104068', '13641873799', '18721532464', '15618443949', '17321077750', '13512134128', '15000515081', '18017005180', '13860021865', '18301896115', '18721256902', '18917056676', '13524668862', '13585661629', '13681844925', '14782346862', '15601652511', '18016391510', '18221205179', '13040754790', '13061654995', '13120501849', '13122557765', '13148119759', '13248255021', '13310183093', '13524574223', '13761639714', '15800537758', '15821200570', '15821659602', '17011962252', '17191340245', '17301836432', '17717853599', '18001793789', '18055579307', '18117395158', '18301742209', '18302116637', '18317112422', '18321008685', '18321580385', '18616936567', '18721110648', '18017258510', '13801689326', '15618336896', '18516108819', '13500318253', '13611789235', '18721021018', '15026770569', '15692116137', '15618267520', '15811471569', '17898825417', '13386177023', '13517617335', '13611956273', '13764450740', '13816429919', '15221872327', '13564368574', '13818605575', '18975615127', '13761369549', '15000301934', '15000784088', '15221075711', '15821785568', '18816969325', '13023289585', '13301689359', '15316317356', '15900866836', '13162655538', '13166348392', '13166387294', '13918584222', '15000086650', '15121152728', '15221948066', '15502140890', '15900661409', '17356700791', '17612165910', '17765178666', '18001666002', '18221443550', '18939993679', '13162042279', '18321653644', '18501607434', '13524407778', '13072117756', '13127522997', '13671739487', '15921150781', '18001906862', '18306768550', '18356805133', '18516033783', '18621541585', '13003181310', '13122788099', '13166458116', '15021591660', '18021040555', '18221651575', '18930834537', '13148117681', '13262823932', '13661543810', '13671986110', '13761576306', '15026582696', '15221065018', '15221802367', '15300795075', '15800845506', '15800905106', '15901717909', '15921929843', '17701790090', '17721237716', '17721486211', '18017522253', '18017601032', '18049792980', '18341453111', '18359968817', '18721803191', '18757994906', '18817997561', '18939917986')
   and `is_black`= 0","");
			if($list!=null){
			    $blacklistLogic=new \Logic\BlackListLogic();
			    $data['bak_type']=3;
			    $data['bak_info']='3月7号批量拉黑';
			    $data['no_login']=1;
			    $data['no_post_replay']=1;
			    $data['no_call']=1;
			    $data['out_house']=2;
			    $data['is_sendmessage']=0;
			    $data['update_man']='system';
			    $data['update_time']=time();
			    $count=0;
			    foreach ($list as $key => $model) {
			        $data['mobile']=$model['mobile'];
			        $data['customer_id']=$model['id'];
			        $result=$blacklistLogic->addMobileForBlack($data);
			        if($result){
			          $count++;
			        }
			    }
			    echo '成功拉黑'.$count.'个用户';
			}else{
			    echo '查询结果集为空';
			}
		}else{
			echo '参数错误';
		}
	}
	
	#更新用户缓存
	public function updateCache(){
		header("content-type:text/html;charset=utf-8");
		if(I('get.handle')=='updateCache'){
			$customerDal=new \Home\Model\customer();
			$list=$customerDal->modelAllCustomer(0,1000," is_monthly=1 ");
			if($list!=null){
				$customerLogic=new \Logic\CustomerLogic();
			    foreach ($list as $key => $value) {
			    	
			    	$customerLogic->updateCustomerCache($value);
			    }
			   
			}
		}else{
			echo '参数错误';
		}
	}

	public function test(){
		switch (I('get.handle')) {
			case 'monthlyAddBlack':
				$handleLogic=new \Logic\CommissionLogic();
				$handleLogic->monthlyAddBlack();
				break;
			case 'resetDelete':
				$this->resetDelete();
			default:
				# code...
				break;
		}
	}

	#批量恢复删除
	public function resetDelete(){
		$roomLogic=new \Logic\HouseRoomLogic();
		$dal=new \Home\Model\houseroom();
		$resourceDal=new \Home\Model\houseresource();
		$handleSelect=new \Logic\HouseSelectLogic();
		$recordHandle=new \Logic\HouseupdatelogLogic();
		$list=$dal->getFieldsByWhere("id,status,record_status,resource_id"," record_status=0 and room_no in('SH201705030337115', 'SH201705030314143', 'SH201705030398551', 'SH201705030336601', 'SH201705030355043', 'SH201705030371643', 'SH201705030363302', 'SH201705030354031', 'SH201705030378848', 'SH201705030387446', 'SH201705030315008', 'SH201705030392295', 'SH201705030351949', 'SH201705030361708', 'SH201705030310621', 'SH201705030331471', 'SH201705030324795', 'SH201705030365704', 'SH201705030349937', 'SH201705030393276', 'SH201705030351361', 'SH201705030369136', 'SH201705030361414', 'SH201705030351488', 'SH201705030376374', 'SH201705030388445', 'SH201705030379795', 'SH201705030310924', 'SH201705030390899', 'SH201705030399852', 'SH201705030371928', 'SH201705030354095', 'SH201705030321897', 'SH201705030366081', 'SH201705030393150', 'SH201705030314280', 'SH201705030351884', 'SH201705030372886', 'SH201705030344664', 'SH201705030354865', 'SH201705020316337', 'SH201705030379931', 'SH201705030360577', 'SH201705030342698', 'SH201705030388397', 'SH201705030321737', 'SH201705030333084', 'SH201705030399872', 'SH201705030367975', 'SH201705030320733', 'SH201705030363959', 'SH201705030374474', 'SH201705030384349', 'SH201705030377671', 'SH201705030395865', 'SH201705030353403', 'SH201705030342061', 'SH201705030311110', 'SH201705030337644', 'SH201705030349919', 'SH201705030387738', 'SH201705030398826', 'SH201705030392404', 'SH201705030350379', 'SH201705030339971', 'SH201705030382720', 'SH201705030384847', 'SH201705030372603', 'SH201705030331837', 'SH201705030370794', 'SH201705030324222', 'SH201705030356175', 'SH201705030381037', 'SH201705030387101', 'SH201705030361952', 'SH201705030383028', 'SH201705030317443', 'SH201705030397254', 'SH201705030393294', 'SH201705030393497', 'SH201705030388908', 'SH201705030315999', 'SH201705030334036', 'SH201705030361713', 'SH201705030321289', 'SH201705030389517', 'SH201705030359860', 'SH201705030340481', 'SH201705030397975', 'SH201705030315288', 'SH201705030362709', 'SH201705030399631', 'SH201705030338908', 'SH201705030398806', 'SH201705030374325', 'SH201705030318710', 'SH201705030359630', 'SH201705030348560', 'SH201705030381527', 'SH201705030315861', 'SH201705030390085', 'SH201705030389108', 'SH201705030310941', 'SH201705030387652', 'SH201705030343071', 'SH201705030380477', 'SH201705030330390', 'SH201705030311123', 'SH201705030384419', 'SH201705030321850', 'SH201705030337354', 'SH201705030312658', 'SH201705030312371', 'SH201705030377030', 'SH201705030341674', 'SH201705030315573', 'SH201705030394785', 'SH201705030365478', 'SH201705030379780', 'SH201705030329290', 'SH201705030315911', 'SH201705030349706', 'SH201705030358479', 'SH201705030343769', 'SH201705030357142', 'SH201705030333988', 'SH201705030351745', 'SH201705030319716', 'SH201705030389722', 'SH201705030310873')");
		foreach ($list as $key => $value) {
			$room_id=$value['id'];
			$updateResult=$roomLogic->updateModel(array('id'=>$room_id,'update_man'=>'system','update_time'=>time(),'record_status'=>1));
			if(!$updateResult){
				continue;
			}
			//更新房源表
			$updateResult=$resourceDal->updateModel(array('id'=>$value['resource_id'],'record_status'=>1,'update_time'=>time(),'update_man'=>'system'));
			if($value['status']==2){
				//添加到搜索表
				$handleSelect->addModel($room_id,0);
			}
			//记录日志
			$recordData['id']=guid();
			$recordData['house_id']=$room_id;
			$recordData['house_type']=2;
			$recordData['update_man']='system';
			$recordData['update_time']=time();
			$recordData['operate_type']='恢复删除';
			$recordHandle->addModel($recordData);
			echo '1';
		}			
	}

}

?>